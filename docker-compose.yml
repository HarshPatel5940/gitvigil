# =============================================================================
# GitVigil Docker Compose
# Self-hosted deployment with PostgreSQL
# =============================================================================
# Usage:
#   1. Copy .env.example to .env and configure
#   2. docker compose up -d
#   3. Access at http://localhost:8080
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  db:
    image: postgres:16-alpine
    container_name: gitvigil-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: gitvigil
      POSTGRES_PASSWORD: ${DB_PASSWORD:-gitvigil}
      POSTGRES_DB: gitvigil
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U gitvigil -d gitvigil"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - gitvigil-network

  # ---------------------------------------------------------------------------
  # GitVigil Application
  # ---------------------------------------------------------------------------
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: gitvigil-app
    restart: unless-stopped
    ports:
      - "${PORT:-8080}:8080"
    environment:
      # Database
      DATABASE_URL: postgres://gitvigil:${DB_PASSWORD:-gitvigil}@db:5432/gitvigil?sslmode=disable

      # Server
      PORT: "8080"
      BASE_URL: ${BASE_URL:-http://localhost:8080}

      # GitHub App (from host .env)
      GITHUB_APP_ID: ${GITHUB_APP_ID}
      GITHUB_APP_CLIENT_ID: ${GITHUB_APP_CLIENT_ID}
      GITHUB_APP_CLIENT_SECRET: ${GITHUB_APP_CLIENT_SECRET}
      GITHUB_WEBHOOK_SECRET: ${GITHUB_WEBHOOK_SECRET}
      # Set this if you mount a private key
      GITHUB_PRIVATE_KEY_PATH: ${GITHUB_PRIVATE_KEY_PATH:-}

      # Detection thresholds
      BACKDATE_SUSPICIOUS_HOURS: ${BACKDATE_SUSPICIOUS_HOURS:-24}
      BACKDATE_CRITICAL_HOURS: ${BACKDATE_CRITICAL_HOURS:-72}
      STREAK_INACTIVITY_HOURS: ${STREAK_INACTIVITY_HOURS:-72}
    # Uncomment and set path to mount private key:
    # volumes:
    #   - ./your-app.private-key.pem:/app/private-key.pem:ro
    depends_on:
      db:
        condition: service_healthy
    networks:
      - gitvigil-network

# =============================================================================
# Networks
# =============================================================================
networks:
  gitvigil-network:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
    driver: local
